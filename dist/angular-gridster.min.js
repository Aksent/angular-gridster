"use strict";angular.module("gridster",[]).controller("GridsterCtrl",function(){return{grid:[],$preview:null,$element:null,options:{width:"auto",columns:6,colWidth:"auto",rowHeight:"match",gridHeight:2,margins:[10,10],isMobile:!1,minColumns:1,maxColumns:10,minRows:1,maxRows:100,defaultSizeX:2,defaultSizeY:1,mobileBreakPoint:600,resizable:{enabled:!0},draggable:{enabled:!0}},init:function($element,$preview){this.$element=$element,this.$preview=$preview},destroy:function(){this.options=this.options.margins=this.grid=this.$element=this.$preview=null},setOptions:function(options){options&&$.extend(!0,this.options,options),"auto"===this.options.width&&(this.options.width=this.$element?this.$element.width():1e3),"auto"===this.options.colWidth&&(this.options.colWidth=(this.options.width-this.options.margins[1])/this.options.columns),"match"===this.options.rowHeight&&(this.options.rowHeight=this.options.colWidth)},redraw:function(){this.setOptions({}),this.options.isMobile=this.options.width<=this.options.mobileBreakPoint;for(var rowIndex=0,l=this.grid.length;l>rowIndex;++rowIndex){var columns=this.grid[rowIndex];if(columns)for(var colIndex=0,len=columns.length;len>colIndex;++colIndex)if(columns[colIndex]){var item=columns[colIndex],$el=item.$element;this.setElementPosition($el,item.row,item.col),this.setElementSizeY($el,item.sizeY),this.setElementSizeX($el,item.sizeX)}}},canItemOccupy:function(item,row,column){return row>-1&&column>-1&&item.sizeX+column<=this.options.columns},autoSetItemPosition:function(item){for(var rowIndex=0;rowIndex<this.options.maxRows;++rowIndex)for(var colIndex=0;colIndex<this.options.columns;++colIndex){var occupied=this.getItem(rowIndex,colIndex),canFit=this.canItemOccupy(item,rowIndex,colIndex);if(!occupied&&canFit)return void this.putItem(item,rowIndex,colIndex)}throw new Error("Unable to place item!")},getItems:function(row,column,sizeX,sizeY,excludeItems){var items=[];sizeX&&sizeY||(sizeX=sizeY=1),!excludeItems||excludeItems instanceof Array||(excludeItems=[excludeItems]);for(var h=0;sizeY>h;++h)for(var w=0;sizeX>w;++w){var item=this.getItem(row+h,column+w,excludeItems);!item||excludeItems&&-1!==excludeItems.indexOf(item)||-1!==items.indexOf(item)||items.push(item)}return items},removeItem:function(item){for(var rowIndex=0,l=this.grid.length;l>rowIndex;++rowIndex){var columns=this.grid[rowIndex];if(columns){var index=columns.indexOf(item);if(-1!==index){columns[index]=null;break}}}this.floatItemsUp(),this.updateHeight()},getItem:function(row,column,excludeItems){!excludeItems||excludeItems instanceof Array||(excludeItems=[excludeItems]);for(var sizeY=1;row>-1;){for(var sizeX=1,col=column;col>-1;){var items=this.grid[row];if(items){var item=items[col];if(item&&(!excludeItems||-1===excludeItems.indexOf(item))&&item.sizeX>=sizeX&&item.sizeY>=sizeY)return item}++sizeX,--col}--row,++sizeY}return null},putItems:function(items){for(var i=0,l=items.length;l>i;++i)this.putItem(items[i])},putItem:function(item,row,column){if(("undefined"==typeof row||null===row)&&(row=item.row,column=item.col,"undefined"==typeof row||null===row))return void this.autoSetItemPosition(item);if(this.canItemOccupy(item,row,column)||(column=Math.min(this.options.columns-item.sizeX,Math.max(0,column)),row=Math.max(0,row)),item&&null!==item.oldRow&&"undefined"!=typeof item.oldRow){if(item.oldRow===row&&item.oldColumn===column)return item.row=row,void(item.col=column);var oldRow=this.grid[item.oldRow];oldRow&&oldRow[item.oldColumn]===item&&delete oldRow[item.oldColumn]}item.oldRow=item.row=row,item.oldColumn=item.col=column,this.moveOverlappingItems(item),this.grid[row]||(this.grid[row]=[]),this.grid[row][column]=item},moveOverlappingItems:function(item){var items=this.getItems(item.row,item.col,item.sizeX,item.sizeY,item);this.moveItemsDown(items,item.row+item.sizeY)},moveItemsDown:function(items,toRow){if(items&&0!==items.length){var item,i,l,topRows={};for(i=0,l=items.length;l>i;++i){item=items[i];var topRow=topRows[item.col];("undefined"==typeof topRow||item.row<topRow)&&(topRows[item.col]=item.row)}for(i=0,l=items.length;l>i;++i){item=items[i];var columnOffset=toRow-topRows[item.col];this.putItem(item,item.row+columnOffset,item.col)}}},floatItemsUp:function(){for(var rowIndex=0,l=this.grid.length;l>rowIndex;++rowIndex){var columns=this.grid[rowIndex];if(columns)for(var colIndex=0,len=columns.length;len>colIndex;++colIndex)columns[colIndex]&&this.floatItemUp(columns[colIndex])}},floatItemUp:function(item){for(var colIndex=item.col,sizeY=item.sizeY,sizeX=item.sizeX,bestRow=null,bestColumn=null,rowIndex=item.row-1;rowIndex>-1;){var items=this.getItems(rowIndex,colIndex,sizeX,sizeY,item);if(0!==items.length)break;bestRow=rowIndex,bestColumn=colIndex,--rowIndex}null!==bestRow&&this.putItem(item,bestRow,bestColumn)},updateHeight:function(plus){var maxHeight=this.options.minRows;plus||(plus=0);for(var rowIndex=this.grid.length;rowIndex>=0;--rowIndex){var columns=this.grid[rowIndex];if(columns)for(var colIndex=0,len=columns.length;len>colIndex;++colIndex)columns[colIndex]&&(maxHeight=Math.max(maxHeight,rowIndex+plus+columns[colIndex].sizeY))}this.options.gridHeight=Math.min(this.options.maxRows,maxHeight)},pixelsToRows:function(pixels,ceilOrFloor){return ceilOrFloor===!0?Math.ceil(pixels/this.options.rowHeight):ceilOrFloor===!1?Math.floor(pixels/this.options.rowHeight):Math.round(pixels/this.options.rowHeight)},pixelsToColumns:function(pixels,ceilOrFloor){return ceilOrFloor===!0?Math.ceil(pixels/this.options.colWidth):ceilOrFloor===!1?Math.floor(pixels/this.options.colWidth):Math.round(pixels/this.options.colWidth)},setElementPosition:function($el,row,column){$el.css(this.options.isMobile?{margin:this.options.margins[0]+"px",top:"auto",left:"auto"}:{margin:0,top:row*this.options.rowHeight+this.options.margins[0],left:column*this.options.colWidth+this.options.margins[1]})},setElementSizeY:function($el,rows){this.options.isMobile?$el.css("height","auto"):$el.css("height",rows*this.options.rowHeight-this.options.margins[0]+"px")},setElementSizeX:function($el,columns){this.options.isMobile?$el.css("width","auto"):$el.css("width",columns*this.options.colWidth-this.options.margins[1]+"px")}}}).directive("gridster",["$parse","$timeout",function($parse,$timeout){return{restrict:"EAC",controller:"GridsterCtrl",compile:function(){return{pre:function(scope,$elem,attrs,controller){var updateHeight=function(){controller.$element.css("height",controller.options.gridHeight*controller.options.rowHeight+controller.options.margins[0]+"px")},optionsKey=attrs.gridster,options={};if(optionsKey){var optionsGetter=$parse(optionsKey);options=optionsGetter(scope),scope.$watch(optionsKey,function(newOptions,oldOptions){newOptions!==oldOptions&&(controller.setOptions(newOptions),"undefined"!=typeof newOptions.draggable&&"undefined"!=typeof oldOptions.draggable&&newOptions.draggable!==oldOptions.draggable&&scope.$broadcast("draggable-changed",newOptions.draggable),"undefined"!=typeof newOptions.resizable&&"undefined"!=typeof oldOptions.resizable&&newOptions.resizable!==oldOptions.resizable&&scope.$broadcast("resizable-changed",newOptions.resizable),controller.redraw(),updateHeight())},!0)}controller.setOptions(options)},post:function(scope,$elem,attrs,controller){function resize(){var width=$elem.width();width===prevWidth||$elem.find(".gridster-item-moving").length>0||(prevWidth=width,$elem.removeClass("gridster-loaded"),controller.redraw(),updateHeight(),scope.$broadcast("gridster-resized",[width,$elem.height()]),$elem.addClass("gridster-loaded"))}$elem.addClass("gridster"),$elem.removeClass("gridster-loaded");var $preview=angular.element('<div class="gridster-item gridster-preview-holder"></div>').appendTo($elem),updateHeight=function(){controller.$element.css("height",controller.options.gridHeight*controller.options.rowHeight+controller.options.margins[0]+"px")};scope.$watch(function(){return controller.options.gridHeight},updateHeight),scope.$watch(function(){return controller.options.isMobile},function(isMobile){isMobile?controller.$element.addClass("gridster-mobile"):controller.$element.removeClass("gridster-mobile")});var prevWidth=$elem.width();angular.element(window).on("resize",function(){resize(),scope.$apply()}),scope.$watch(function(){return $elem.width()},resize),$elem.bind("$destroy",function(){try{this.$preview.remove(),controller.destroy()}catch(e){}}),controller.init($elem,$preview),controller.redraw(),$timeout(function(){controller.floatItemsUp(),$elem.addClass("gridster-loaded")},100)}}}}}]).controller("GridsterItemCtrl",function(){return{$element:null,gridster:null,dragging:!1,resizing:!1,row:null,col:null,sizeX:null,sizeY:null,init:function($element,gridster){this.$element=$element,this.gridster=gridster,this.sizeX=gridster.options.defaultSizeX,this.sizeY=gridster.options.defaultSizeY},destroy:function(){this.gridster=null,this.$element=null},toJSON:function(){return{row:this.row,col:this.col,sizeY:this.sizeY,sizeX:this.sizeX}},setPosition:function(row,column){this.gridster.putItem(this,row,column),this.gridster.floatItemsUp(),this.gridster.updateHeight(this.dragging?this.sizeY:0),this.dragging?this.gridster.setElementPosition(this.gridster.$preview,this.row,this.col):this.gridster.setElementPosition(this.$element,this.row,this.col)},setSize:function(key,value){key=key.toUpperCase();var camelCase="size"+key,titleCase="Size"+key;if(""!==value){value=parseInt(value,10),(isNaN(value)||0===value)&&(value=this.gridster.options["default"+titleCase]);var changed=!(this[camelCase]===value&&this["old"+titleCase]&&this["old"+titleCase]===value);this["old"+titleCase]=this[camelCase]=value,this.resizing?(this.gridster.setElementPosition(this.gridster.$preview,this.row,this.col),this.gridster["setElement"+titleCase](this.gridster.$preview,value)):this.gridster["setElement"+titleCase](this.$element,value),changed&&(this.gridster.moveOverlappingItems(this),this.gridster.floatItemsUp(),this.gridster.updateHeight(this.dragging?this.sizeY:0))}},setSizeY:function(rows){this.setSize("y",rows)},setSizeX:function(columns){this.setSize("x",columns)}}}).directive("gridsterItem",["$parse","$controller","$timeout",function($parse,$controller,$timeout){return{restrict:"EAC",require:"^gridster",link:function(scope,$el,attrs,gridster){function setDraggable(enable){if(draggablePossible)if(enable)$el.draggable({handle:gridster.options.draggable&&gridster.options.draggable.handle?gridster.options.draggable.handle:null,refreshPositions:!0,start:function(e,widget){$el.addClass("gridster-item-moving"),item.dragging=!0,gridster.$preview.show(),gridster.setElementSizeX(gridster.$preview,item.sizeX),gridster.setElementSizeY(gridster.$preview,item.sizeY),gridster.setElementPosition(gridster.$preview,item.row,item.col),gridster.updateHeight(item.sizeY),scope.$apply(),gridster.options.draggable&&gridster.options.draggable.start&&(gridster.options.draggable.start(e,widget,$el),scope.$apply())},drag:function(e,widget){item.row=gridster.pixelsToRows(widget.position.top),item.col=gridster.pixelsToColumns(widget.position.left),scope.$apply(),gridster.options.draggable&&gridster.options.draggable.drag&&(gridster.options.draggable.drag(e,widget,$el),scope.$apply())},stop:function(e,widget){$el.removeClass("gridster-item-moving"),item.row=gridster.pixelsToRows(widget.position.top),item.col=gridster.pixelsToColumns(widget.position.left),item.dragging=!1,gridster.$preview.hide(),item.setPosition(item.row,item.col),gridster.updateHeight(),scope.$apply(),gridster.options.draggable&&gridster.options.draggable.stop&&(gridster.options.draggable.stop(e,widget,$el),scope.$apply())}});else try{$el.draggable("destroy")}catch(e){}}function updateResizableDimensions(enabled){resizablePossible&&enabled&&($el.resizable("option","minHeight",gridster.options.minRows*gridster.options.rowHeight-gridster.options.margins[0]),$el.resizable("option","maxHeight",gridster.options.maxRows*gridster.options.rowHeight-gridster.options.margins[0]),$el.resizable("option","minWidth",gridster.options.minColumns*gridster.options.colWidth-gridster.options.margins[1]),$el.resizable("option","maxWidth",gridster.options.maxColumns*gridster.options.colWidth-gridster.options.margins[1]))}function setResizable(enable){if(resizablePossible)if(enable)$el.resizable({autoHide:!0,handles:"n, e, s, w, ne, se, sw, nw",minHeight:gridster.options.minRows*gridster.options.rowHeight-gridster.options.margins[0],maxHeight:gridster.options.maxRows*gridster.options.rowHeight-gridster.options.margins[0],minWidth:gridster.options.minColumns*gridster.options.colWidth-gridster.options.margins[1],maxWidth:gridster.options.maxColumns*gridster.options.colWidth-gridster.options.margins[1],start:function(e,widget){$el.addClass("gridster-item-moving"),item.resizing=!0,item.dragging=!0,gridster.$preview.fadeIn(300),gridster.setElementSizeX(gridster.$preview,item.sizeX),gridster.setElementSizeY(gridster.$preview,item.sizeY),scope.$apply(),gridster.options.resizable&&gridster.options.resizable.start&&(gridster.options.resizable.start(e,widget,$el),scope.$apply())},resize:function(e,widget){item.row=gridster.pixelsToRows(widget.position.top,!1),item.col=gridster.pixelsToColumns(widget.position.left,!1),item.sizeX=gridster.pixelsToColumns(widget.size.width,!0),item.sizeY=gridster.pixelsToRows(widget.size.height,!0),scope.$apply(),gridster.options.resizable&&gridster.options.resizable.resize&&(gridster.options.resizable.resize(e,widget,$el),scope.$apply())},stop:function(e,widget){$el.removeClass("gridster-item-moving"),item.row=gridster.pixelsToRows(widget.position.top,!1),item.col=gridster.pixelsToColumns(widget.position.left,!1),item.sizeX=gridster.pixelsToColumns(widget.size.width,!0),item.sizeY=gridster.pixelsToRows(widget.size.height,!0),item.resizing=!1,item.dragging=!1,gridster.$preview.fadeOut(300),item.setPosition(item.row,item.col),item.setSizeY(item.sizeY),item.setSizeX(item.sizeX),scope.$apply(),gridster.options.resizable&&gridster.options.resizable.stop&&(gridster.options.resizable.stop(e,widget,$el),scope.$apply())}});else try{$el.resizable("destroy")}catch(e){}}function positionChanged(){item.setPosition(item.row,item.col),$getters.row&&$getters.row.assign&&$getters.row.assign(scope,item.row),$getters.col&&$getters.col.assign&&$getters.col.assign(scope,item.col)}var options,optionsKey=attrs.gridsterItem,item=$controller("GridsterItemCtrl"),draggablePossible="function"==typeof $el.draggable,resizablePossible="function"==typeof $el.resizable;if(optionsKey){var $optionsGetter=$parse(optionsKey);options=$optionsGetter(scope)||{},!options&&$optionsGetter.assign&&(options={row:item.row,col:item.col,sizeX:item.sizeX,sizeY:item.sizeY},$optionsGetter.assign(scope,options))}else options=attrs;item.init($el,gridster),$el.addClass("gridster-item"),$el.addClass("gridster-item-moving");for(var aspects=["sizeX","sizeY","row","col"],$getters={},aspectFn=function(aspect){var key;if("string"==typeof options[aspect])key=options[aspect];else if("string"==typeof options[aspect.toLowerCase()])key=options[aspect.toLowerCase()];else{if(!optionsKey)return;key=$parse(optionsKey+"."+aspect)}$getters[aspect]=$parse(key),scope.$watch(key,function(newVal){newVal=parseInt(newVal,10),isNaN(newVal)||(item[aspect]=newVal)});var val=$getters[aspect](scope);"number"==typeof val&&(item[aspect]=val)},i=0,l=aspects.length;l>i;++i)aspectFn(aspects[i]);return scope.$watch(function(){return item.row},positionChanged),scope.$watch(function(){return item.col},positionChanged),scope.$on("draggable-changed",function(event,draggable){setDraggable(draggable.enabled)}),scope.$on("resizable-changed",function(event,resizable){setResizable(resizable.enabled)}),scope.$on("gridster-resized",function(){updateResizableDimensions("undefined"!=typeof gridster.options.resizable&&"undefined"!=typeof gridster.options.resizable.enabled&&gridster.options.resizable.enabled)}),setDraggable("undefined"!=typeof gridster.options.draggable&&"undefined"!=typeof gridster.options.draggable.enabled&&gridster.options.draggable.enabled),setResizable("undefined"!=typeof gridster.options.resizable&&"undefined"!=typeof gridster.options.resizable.enabled&&gridster.options.resizable.enabled),scope.$watch(function(){return item.sizeY},function(sizeY){item.setSizeY(sizeY),$getters.sizeY&&$getters.sizeY.assign&&$getters.sizeY.assign(scope,item.sizeY)}),scope.$watch(function(){return item.sizeX},function(sizeX){item.setSizeX(sizeX),$getters.sizeX&&$getters.sizeX.assign&&$getters.sizeX.assign(scope,item.sizeX)}),$timeout(function(){$el.removeClass("gridster-item-moving")},100),$el.bind("$destroy",function(){try{gridster.removeItem(item)}catch(e){}try{item.destroy()}catch(e){}try{$el.draggable("destroy")}catch(e){}try{$el.resizable("destroy")}catch(e){}})}}}]);